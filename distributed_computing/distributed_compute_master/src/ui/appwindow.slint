// src/ui/appwindow.slint - UPDATED with Camera Preview Support

import { LineEdit, Button, TextEdit, ListView, HorizontalBox, VerticalBox, TabWidget, ScrollView } from "std-widgets.slint";

export struct ResourceStats {
    cpu-usage: float,
    cpu-cores: int,
    gpu-usage: float,
    gpu-vram-used: float,
    gpu-vram-total: float,
    ram-used: float,
    ram-total: float,
    storage-used: float,
    storage-total: float,
}

export struct WorkerNode {
    id: string,
    ip: string,
    status: string,
    cpu-usage: float,
    ram-usage: float,
    gpu-usage: float,
    has-camera: bool,
    location: string,
}

export struct ThreatEvent {
    id: string,
    camera-id: string,
    threat-type: string,
    severity: string,
    confidence: float,
    timestamp: string,
    location: string,
    description: string,
}

export struct CameraFeed {
    camera-id: string,
    worker-id: string,
    location: string,
    status: string,
    threat-level: string,
    active-threats: int,
}

export struct ResponseAction {
    action-type: string,
    target: string,
    priority: int,
    description: string,
    status: string,
}

export component AppWindow inherits Window {
    title: "M4N Distributed Intelligence System";
    preferred-width: 1600px;
    preferred-height: 900px;

    // Original properties
    in property <string> connection-status: "Disconnected";
    in property <string> log-text: "System started. Ready to connect.";
    in-out property <string> server-ip: "127.0.0.1";
    in property <ResourceStats> resource-stats: {
        cpu-usage: 0,
        cpu-cores: 0,
        gpu-usage: 0,
        gpu-vram-used: 0,
        gpu-vram-total: 0,
        ram-used: 0,
        ram-total: 0,
        storage-used: 0,
        storage-total: 0,
    };
    in property <[WorkerNode]> workers: [];

    // Threat Intelligence properties
    in property <[ThreatEvent]> threats: [];
    in property <[CameraFeed]> cameras: [];
    in property <[ResponseAction]> active-responses: [];
    in property <int> total-threats: 0;
    in property <int> critical-threats: 0;
    in property <bool> threat-monitoring-active: false;

    // NEW: Camera frame preview properties
    in property <image> camera-frame;
    in property <string> camera-id: "No camera";

    // Original callbacks
    callback connect-requested(ip_address: string);
    callback send-test-task();
    callback refresh-stats();

    // Threat Intelligence callbacks
    callback start-threat-monitoring();
    callback stop-threat-monitoring();
    callback acknowledge-threat(threat-id: string);
    callback execute-response-plan(threat-id: string);
    callback analyze-geospatial();
    callback analyze-network();

    VerticalLayout {
        spacing: 0px;
        
        // Top toolbar (Enhanced)
        Rectangle {
            background: #1a1a2e;
            height: 60px;
            
            HorizontalLayout {
                padding: 8px;
                spacing: 15px;
                alignment: space-between;

                // Left side - Original controls
                HorizontalLayout {
                    spacing: 10px;
                    
                    Text { 
                        text: "Worker IP:"; 
                        color: white;
                        vertical-alignment: center; 
                    }
                    
                    server-ip-input := LineEdit {
                        text: server-ip;
                        width: 180px;
                    }
                    
                    Button {
                        text: "Connect Worker";
                        primary: true;
                        clicked => {
                            root.connect-requested(server-ip-input.text);
                        }
                    }
                    
                    Button {
                        text: "Send Task";
                        clicked => { root.send-test-task(); }
                    }
                    
                    Button {
                        text: "âŸ³";
                        clicked => { root.refresh-stats(); }
                    }
                }

                // Right side - Threat controls
                HorizontalLayout {
                    spacing: 10px;
                    
                    if threat-monitoring-active: Rectangle {
                        background: #c0392b;
                        border-radius: 4px;
                        padding: 8px;
                        
                        HorizontalLayout {
                            spacing: 6px;
                            
                            Rectangle {
                                width: 10px;
                                height: 10px;
                                background: white;
                                border-radius: 5px;
                            }
                            
                            Text {
                                text: "MONITORING ACTIVE";
                                color: white;
                                font-size: 11px;
                                font-weight: 700;
                                vertical-alignment: center;
                            }
                        }
                    }
                    
                    Button {
                        text: threat-monitoring-active ? "â¸ Stop Monitoring" : "â–¶ Start Monitoring";
                        primary: !threat-monitoring-active;
                        clicked => {
                            if threat-monitoring-active {
                                root.stop-threat-monitoring();
                            } else {
                                root.start-threat-monitoring();
                            }
                        }
                    }
                    
                    Button {
                        text: "ðŸ—ºï¸ Geo Analysis";
                        clicked => { root.analyze-geospatial(); }
                    }
                    
                    Button {
                        text: "ðŸ•¸ï¸ Network Analysis";
                        clicked => { root.analyze-network(); }
                    }
                }
            }
        }

        // Status bar (Enhanced)
        Rectangle {
            background: #2c3e50;
            height: 40px;
            
            HorizontalLayout {
                padding-left: 15px;
                padding-right: 15px;
                spacing: 30px;
                alignment: space-between;
                
                Text {
                    text: "â— " + connection-status;
                    color: connection-status == "Connected" ? #2ecc71 : #e74c3c;
                    vertical-alignment: center;
                    font-weight: 600;
                }
                
                Text {
                    text: "Workers: " + workers.length;
                    color: white;
                    vertical-alignment: center;
                }
                
                Text {
                    text: "ðŸ“¹ Cameras: " + cameras.length;
                    color: #3498db;
                    vertical-alignment: center;
                }
                
                Text {
                    text: "âš ï¸ Threats: " + total-threats;
                    color: total-threats > 0 ? #f39c12 : #95a5a6;
                    vertical-alignment: center;
                }
                
                Text {
                    text: "ðŸš¨ Critical: " + critical-threats;
                    color: critical-threats > 0 ? #e74c3c : #95a5a6;
                    vertical-alignment: center;
                    font-weight: critical-threats > 0 ? 700 : 400;
                }
            }
        }

        // Main content with tabs
        TabWidget {
            Tab {
                title: "ðŸ“Š Compute & Resources";
                
                HorizontalLayout {
                    spacing: 0px;
                    
                    // Left sidebar - Resource monitoring
                    Rectangle {
                        background: #2c3e50;
                        width: 280px;
                        
                        VerticalLayout {
                            padding: 10px;
                            spacing: 15px;
                            
                            Text {
                                text: "SYSTEM RESOURCES";
                                color: #3498db;
                                font-weight: 700;
                                font-size: 14px;
                            }
                            
                            // CPU Section
                            Rectangle {
                                background: #34495e;
                                border-radius: 4px;
                                height: 100px;
                                
                                VerticalLayout {
                                    padding: 10px;
                                    spacing: 5px;
                                    
                                    Text {
                                        text: "CPU";
                                        color: #ecf0f1;
                                        font-weight: 600;
                                    }
                                    
                                    HorizontalLayout {
                                        Text {
                                            text: "Usage:";
                                            color: #bdc3c7;
                                            font-size: 12px;
                                        }
                                        Text {
                                            text: round(resource-stats.cpu-usage) + "%";
                                            color: white;
                                            font-size: 12px;
                                        }
                                    }
                                    
                                    Rectangle {
                                        height: 20px;
                                        background: #1e272e;
                                        border-radius: 3px;
                                        
                                        Rectangle {
                                            width: parent.width * resource-stats.cpu-usage / 100;
                                            background: #3498db;
                                            border-radius: 3px;
                                        }
                                    }
                                    
                                    Text {
                                        text: "Cores: " + resource-stats.cpu-cores;
                                        color: #bdc3c7;
                                        font-size: 11px;
                                    }
                                }
                            }
                            
                            // GPU Section
                            Rectangle {
                                background: #34495e;
                                border-radius: 4px;
                                height: 100px;
                                
                                VerticalLayout {
                                    padding: 10px;
                                    spacing: 5px;
                                    
                                    Text {
                                        text: "GPU";
                                        color: #ecf0f1;
                                        font-weight: 600;
                                    }
                                    
                                    HorizontalLayout {
                                        Text {
                                            text: "Usage:";
                                            color: #bdc3c7;
                                            font-size: 12px;
                                        }
                                        Text {
                                            text: round(resource-stats.gpu-usage) + "%";
                                            color: white;
                                            font-size: 12px;
                                        }
                                    }
                                    
                                    Rectangle {
                                        height: 20px;
                                        background: #1e272e;
                                        border-radius: 3px;
                                        
                                        Rectangle {
                                            width: parent.width * resource-stats.gpu-usage / 100;
                                            background: #9b59b6;
                                            border-radius: 3px;
                                        }
                                    }
                                    
                                    Text {
                                        text: "VRAM: " + round(resource-stats.gpu-vram-used) + " / " + round(resource-stats.gpu-vram-total) + " MB";
                                        color: #bdc3c7;
                                        font-size: 11px;
                                    }
                                }
                            }
                            
                            // RAM Section
                            Rectangle {
                                background: #34495e;
                                border-radius: 4px;
                                height: 100px;
                                
                                VerticalLayout {
                                    padding: 10px;
                                    spacing: 5px;
                                    
                                    Text {
                                        text: "RAM";
                                        color: #ecf0f1;
                                        font-weight: 600;
                                    }
                                    
                                    HorizontalLayout {
                                        Text {
                                            text: "Used:";
                                            color: #bdc3c7;
                                            font-size: 12px;
                                        }
                                        Text {
                                            text: round(resource-stats.ram-used / 1024) + " / " + 
                                                  round(resource-stats.ram-total / 1024) + " GB";
                                            color: white;
                                            font-size: 12px;
                                        }
                                    }
                                    
                                    Rectangle {
                                        height: 20px;
                                        background: #1e272e;
                                        border-radius: 3px;
                                        
                                        Rectangle {
                                            width: parent.width * resource-stats.ram-used / resource-stats.ram-total;
                                            background: #e74c3c;
                                            border-radius: 3px;
                                        }
                                    }
                                    
                                    Text {
                                        text: round(resource-stats.ram-used / resource-stats.ram-total * 100) + "% used";
                                        color: #bdc3c7;
                                        font-size: 11px;
                                    }
                                }
                            }
                        }
                    }
                    
                    // Main content area
                    Rectangle {
                        background: #ecf0f1;
                        
                        VerticalLayout {
                            spacing: 0px;
                            
                            // Workers list
                            Rectangle {
                                background: white;
                                
                                VerticalLayout {
                                    padding: 15px;
                                    spacing: 10px;
                                    
                                    Text {
                                        text: "Connected Workers";
                                        font-size: 16px;
                                        font-weight: 600;
                                    }
                                    
                                    Rectangle {
                                        background: #ecf0f1;
                                        border-radius: 4px;
                                        height: 250px;
                                        
                                        ListView {
                                            for worker in workers: Rectangle {
                                                height: 45px;
                                                background: worker.status == "Active" ? #d5f4e6 : #f8d7da;
                                                border-radius: 3px;
                                                
                                                HorizontalLayout {
                                                    padding: 10px;
                                                    spacing: 15px;
                                                    alignment: space-between;
                                                    
                                                    HorizontalLayout {
                                                        spacing: 8px;
                                                        
                                                        Text {
                                                            text: worker.id;
                                                            font-weight: 600;
                                                            vertical-alignment: center;
                                                        }
                                                        
                                                        if worker.has-camera: Text {
                                                            text: "ðŸ“¹";
                                                            vertical-alignment: center;
                                                        }
                                                    }
                                                    
                                                    Text {
                                                        text: worker.ip;
                                                        color: #7f8c8d;
                                                        vertical-alignment: center;
                                                    }
                                                    
                                                    if worker.has-camera: Text {
                                                        text: "ðŸ“ " + worker.location;
                                                        color: #3498db;
                                                        font-size: 11px;
                                                        vertical-alignment: center;
                                                    }
                                                    
                                                    Text {
                                                        text: "CPU: " + round(worker.cpu-usage) + "%";
                                                        color: #7f8c8d;
                                                        font-size: 12px;
                                                        vertical-alignment: center;
                                                    }
                                                    
                                                    Text {
                                                        text: "RAM: " + round(worker.ram-usage) + "%";
                                                        color: #7f8c8d;
                                                        font-size: 12px;
                                                        vertical-alignment: center;
                                                    }
                                                    
                                                    Text {
                                                        text: worker.status;
                                                        color: worker.status == "Active" ? #27ae60 : #c0392b;
                                                        font-weight: 600;
                                                        vertical-alignment: center;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            
                            // Log section
                            Rectangle {
                                background: white;
                                
                                VerticalLayout {
                                    padding: 15px;
                                    spacing: 10px;
                                    
                                    Text {
                                        text: "Activity Log";
                                        font-size: 16px;
                                        font-weight: 600;
                                    }
                                    
                                    Rectangle {
                                        background: #1e272e;
                                        border-radius: 4px;
                                        
                                        log_area := TextEdit {
                                            text: log-text;
                                            read-only: true;
                                            wrap: word-wrap;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            Tab {
                title: "ðŸ›¡ï¸ Threat Intelligence";
                
                HorizontalLayout {
                    spacing: 10px;
                    padding: 10px;
                    
                    // Camera Grid with LIVE PREVIEW (Left 60%)
                    Rectangle {
                        background: #0f0f1e;
                        border-radius: 8px;
                        
                        VerticalLayout {
                            padding: 15px;
                            spacing: 12px;
                            
                            HorizontalLayout {
                                spacing: 10px;
                                alignment: space-between;
                                
                                Text {
                                    text: "CAMERA NETWORK";
                                    color: #3498db;
                                    font-weight: 700;
                                    font-size: 15px;
                                }
                                
                                // Camera ID indicator
                                Rectangle {
                                    background: #1a1a2e;
                                    border-radius: 4px;
                                    padding: 6px;
                                    
                                    HorizontalLayout {
                                        spacing: 6px;
                                        
                                        Rectangle {
                                            width: 8px;
                                            height: 8px;
                                            background: #2ecc71;
                                            border-radius: 4px;
                                        }
                                        
                                        Text {
                                            text: camera-id;
                                            color: white;
                                            font-size: 11px;
                                            font-weight: 600;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }
                            
                            // LIVE CAMERA PREVIEW
                            Rectangle {
                                background: #000;
                                border-radius: 8px;
                                height: 400px;
                                border-width: 2px;
                                border-color: #2ecc71;
                                
                                if camera-frame.width > 0: Image {
                                    source: camera-frame;
                                    width: 100%;
                                    height: 100%;
                                    image-fit: contain;
                                }
                                
                                if camera-frame.width == 0: VerticalLayout {
                                    alignment: center;
                                    
                                    Text {
                                        text: "ðŸ“¹";
                                        color: #404040;
                                        font-size: 48px;
                                        horizontal-alignment: center;
                                    }
                                    
                                    Text {
                                        text: "Waiting for camera feed...";
                                        color: #606060;
                                        font-size: 14px;
                                        horizontal-alignment: center;
                                    }
                                }
                                
                                // Live indicator overlay
                                Rectangle {
                                    x: 10px;
                                    y: 10px;
                                    width: 80px;
                                    height: 28px;
                                    background: #c0392b;
                                    border-radius: 4px;
                                    
                                    HorizontalLayout {
                                        padding: 6px;
                                        spacing: 6px;
                                        
                                        Rectangle {
                                            width: 10px;
                                            height: 10px;
                                            background: white;
                                            border-radius: 5px;
                                        }
                                        
                                        Text {
                                            text: "LIVE";
                                            color: white;
                                            font-size: 12px;
                                            font-weight: 700;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }
                            
                            // Camera List (smaller thumbnails)
                            ScrollView {
                                viewport-height: 240px;
                                
                                VerticalLayout {
                                    spacing: 8px;
                                    
                                    for camera in cameras: Rectangle {
                                        background: #1a1a2e;
                                        border-radius: 6px;
                                        height: 70px;
                                        
                                        HorizontalLayout {
                                            padding: 8px;
                                            spacing: 10px;
                                            
                                            // Camera thumbnail
                                            Rectangle {
                                                width: 100px;
                                                background: #000;
                                                border-radius: 4px;
                                                
                                                Text {
                                                    text: "ðŸ“¹";
                                                    color: #404040;
                                                    font-size: 20px;
                                                    horizontal-alignment: center;
                                                    vertical-alignment: center;
                                                }
                                            }
                                            
                                            VerticalLayout {
                                                spacing: 4px;
                                                
                                                HorizontalLayout {
                                                    spacing: 6px;
                                                    alignment: space-between;
                                                    
                                                    HorizontalLayout {
                                                        spacing: 6px;
                                                        
                                                        Rectangle {
                                                            width: 6px;
                                                            height: 6px;
                                                            background: camera.status == "active" ? #2ecc71 : #e74c3c;
                                                            border-radius: 3px;
                                                        }
                                                        
                                                        Text {
                                                            text: camera.camera-id;
                                                            color: white;
                                                            font-weight: 600;
                                                            font-size: 12px;
                                                            vertical-alignment: center;
                                                        }
                                                    }
                                                    
                                                    Rectangle {
                                                        background: camera.threat-level == "CRITICAL" ? #c0392b :
                                                                   camera.threat-level == "HIGH" ? #e67e22 :
                                                                   camera.threat-level == "MEDIUM" ? #f39c12 : #27ae60;
                                                        border-radius: 3px;
                                                        padding: 3px;
                                                        
                                                        Text {
                                                            text: camera.threat-level;
                                                            color: white;
                                                            font-size: 9px;
                                                            font-weight: 700;
                                                        }
                                                    }
                                                }
                                                
                                                Text {
                                                    text: "ðŸ“ " + camera.location;
                                                    color: #95a5a6;
                                                    font-size: 10px;
                                                }
                                                
                                                Text {
                                                    text: "Active: " + camera.active-threats;
                                                    color: camera.active-threats > 0 ? #e74c3c : #27ae60;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // Threat Feed + Response Panel (Right 40%)
                    VerticalLayout {
                        spacing: 10px;
                        width: 450px;
                        
                        // Threat Log
                        Rectangle {
                            background: #16213e;
                            border-radius: 8px;
                            height: 400px;
                            
                            VerticalLayout {
                                padding: 15px;
                                spacing: 10px;
                                
                                Text {
                                    text: "THREAT LOG";
                                    color: white;
                                    font-weight: 700;
                                    font-size: 14px;
                                }
                                
                                ScrollView {
                                    viewport-height: 350px;
                                    
                                    VerticalLayout {
                                        spacing: 8px;
                                        
                                        for threat in threats: Rectangle {
                                            background: threat.severity == "CRITICAL" ? #3d1e1e :
                                                       threat.severity == "HIGH" ? #3d2e1e :
                                                       threat.severity == "MEDIUM" ? #3d3d1e : #1e3d1e;
                                            border-radius: 4px;
                                            
                                            VerticalLayout {
                                                padding: 10px;
                                                spacing: 6px;
                                                
                                                HorizontalLayout {
                                                    spacing: 8px;
                                                    alignment: space-between;
                                                    
                                                    Rectangle {
                                                        background: threat.severity == "CRITICAL" ? #c0392b :
                                                                   threat.severity == "HIGH" ? #e67e22 :
                                                                   threat.severity == "MEDIUM" ? #f39c12 : #27ae60;
                                                        border-radius: 3px;
                                                        padding: 3px;
                                                        
                                                        Text {
                                                            text: threat.severity;
                                                            color: white;
                                                            font-size: 9px;
                                                            font-weight: 700;
                                                        }
                                                    }
                                                    
                                                    Text {
                                                        text: threat.timestamp;
                                                        color: #7f8c8d;
                                                        font-size: 10px;
                                                        vertical-alignment: center;
                                                    }
                                                }
                                                
                                                Text {
                                                    text: threat.description;
                                                    color: white;
                                                    font-size: 12px;
                                                    font-weight: 600;
                                                }
                                                
                                                HorizontalLayout {
                                                    spacing: 10px;
                                                    
                                                    Text {
                                                        text: threat.threat-type;
                                                        color: #95a5a6;
                                                        font-size: 10px;
                                                    }
                                                    
                                                    Text {
                                                        text: round(threat.confidence * 100) + "%";
                                                        color: #95a5a6;
                                                        font-size: 10px;
                                                    }
                                                }
                                                
                                                Button {
                                                    text: "Generate Response";
                                                    clicked => {
                                                        root.execute-response-plan(threat.id);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        // Active Responses
                        Rectangle {
                            background: #0f3460;
                            border-radius: 8px;
                            
                            VerticalLayout {
                                padding: 15px;
                                spacing: 10px;
                                
                                Text {
                                    text: "ACTIVE RESPONSES";
                                    color: white;
                                    font-weight: 700;
                                    font-size: 14px;
                                }
                                
                                ScrollView {
                                    viewport-height: 250px;
                                    
                                    VerticalLayout {
                                        spacing: 8px;
                                        
                                        for action in active-responses: Rectangle {
                                            background: #16213e;
                                            border-radius: 4px;
                                            
                                            VerticalLayout {
                                                padding: 10px;
                                                spacing: 5px;
                                                
                                                HorizontalLayout {
                                                    spacing: 8px;
                                                    alignment: space-between;
                                                    
                                                    Text {
                                                        text: action.action-type;
                                                        color: white;
                                                        font-weight: 600;
                                                        font-size: 12px;
                                                        vertical-alignment: center;
                                                    }
                                                    
                                                    Text {
                                                        text: "P" + action.priority;
                                                        color: action.priority == 1 ? #e74c3c : #f39c12;
                                                        font-size: 11px;
                                                        font-weight: 700;
                                                        vertical-alignment: center;
                                                    }
                                                }
                                                
                                                Text {
                                                    text: action.description;
                                                    color: #95a5a6;
                                                    font-size: 11px;
                                                }
                                                
                                                Rectangle {
                                                    height: 4px;
                                                    background: #1e272e;
                                                    border-radius: 2px;
                                                    
                                                    Rectangle {
                                                        width: action.status == "completed" ? parent.width :
                                                               action.status == "executing" ? parent.width * 0.6 :
                                                               parent.width * 0.2;
                                                        background: action.status == "completed" ? #27ae60 :
                                                                   action.status == "executing" ? #f39c12 : #3498db;
                                                        border-radius: 2px;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}